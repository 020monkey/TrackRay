package com.trackray.module.exploit;

import com.trackray.base.annotation.Plugin;
import com.trackray.base.bean.HostInfo;
import com.trackray.base.bean.Result;
import com.trackray.base.bean.Task;
import com.trackray.base.enums.HttpMethod;
import com.trackray.base.exploit.AbstractExploit;
import com.trackray.base.httpclient.CrawlerPage;
import com.trackray.base.utils.ExtractUtils;
import com.trackray.base.utils.RegexUtil;
import net.dongliu.requests.Requests;
import net.sf.json.JSONObject;
import org.apache.commons.lang3.StringUtils;
import org.javaweb.core.net.HttpResponse;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.io.IOException;
import java.net.MalformedURLException;
import java.net.URISyntaxException;
import java.net.URL;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Set;

/**
 * @author 浅蓝
 * @email blue@ixsec.org
 * @since 2019/5/13 15:40
 */
@Plugin(title = "fuckTheWebsiteEverything" , author = "浅蓝")
public class FuckTheWebsiteEverything extends AbstractExploit {
    @Override
    public void attack(Task task) {

        HostInfo hostInfo = task.getResult().getHostInfo();
        for (String dns : hostInfo.getDns()) {

            dns = dns.toUpperCase();

            if (dns.contains("CLOUDFLARE"))
                hostInfo.setCdn(true);


        }

        for (String ip : hostInfo.getOtherIP()) {
            try {
                String text = Requests.get("http://" + ip).send().readToText();
                if (text.contains("Cloudflare")){
                    hostInfo.setCdn(true);
                }

                if (text.contains(task.getResult().getAdditional().get("网站标题").toString())){
                    task.getResult().getAdditional().put("通过多地PING的IP提取出疑似真实IP",ip);
                }
            }catch (Exception e){
                continue;
            }

        }

        if (task.getResult().getAdditional().containsKey("域名历史解析记录")){
            HashMap<String,String> map = (HashMap<String, String>) task.getResult().getAdditional().get("域名历史解析记录");
            for (String ip : map.keySet()) {
                try {
                    String text = Requests.get("http://" + ip).send().readToText();
                    if (text.contains(task.getResult().getAdditional().get("网站标题").toString())){
                        task.getResult().getAdditional().put("通过历史解析记录提取出疑似真实IP",ip);
                    }
                }catch (Exception e){
                    continue;
                }
            }

        }


    }




    @Override
    public boolean check(Result result) {
        return true;
    }
}
