package com.trackray.base.exploit;

import com.trackray.base.bean.*;
import com.trackray.base.httpclient.CrawlerPage;
import com.trackray.base.httpclient.Fetcher;
import com.trackray.base.store.VulnDTO;
import com.trackray.base.store.VulnRepository;
import com.trackray.base.utils.PageUtils;
import org.javaweb.core.net.HttpURLRequest;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.ArrayList;
import java.util.List;


/**
 * exploit抽象类
 * @author 浅蓝
 * @email blue@ixsec.org
 * @since 2019/1/8 12:28
 */
public abstract class AbstractExploit implements Runnable{
    @Deprecated
    protected static Fetcher fetcher = new Fetcher();
    @Deprecated
    protected CrawlerPage crawlerPage = new CrawlerPage();

    @Autowired
    private VulnRepository vulnRepository;

    protected HttpURLRequest requests = new HttpURLRequest();    //请求类

    private String target;

    private static final Logger log = LoggerFactory.getLogger(AbstractExploit.class);

    private List<Vulnerable> vulns = new ArrayList<>();

    private Task task;

    public void before(){
        //...
    }

    public abstract void attack(Task task);

    public abstract boolean check(Result result);

    @Override

    public void run() {
        executor();
    }

    public void executor(){
        //PageUtils.copyTaskProxy(task,crawlerPage);
        if (check(task.getResult())){
            before();

            attack(task);

            after();
        }
    }

    public void addVulnerable(Vulnerable vulnerable){
        VulnDTO vuln = new VulnDTO();
        vuln.setAddress(vulnerable.getAddress());
        vuln.setLevel(vulnerable.getLevel());
        //vuln.setMessage(vulnerable.);

        if (vulnerable.getReferences()!=null)
            vuln.setReference((String[]) vulnerable.getReferences().toArray());
        if (vulnerable.getRisk()!=null)
            vuln.setRisk((String[]) vulnerable.getRisk().toArray());
        if (vulnerable.getVulnId()!=null)
            vuln.setVulnId((String[]) vulnerable.getVulnId().toArray());

        vuln.setPayload(vulnerable.getPayload());
        vuln.setRepair(vulnerable.getRepair());
        vuln.setTitle(vulnerable.getTitle());
        vuln.setTaskMd5(this.task.getTaskMD5());
        vuln.setType(vulnerable.getType());

        try {
            VulnDTO save = vulnRepository.save(vuln);
            if (save!=null)
                log.info(vuln.getTitle()+ " 漏洞已添加到数据库");
        }catch (Exception e){
            log.error(vuln.getTitle()+ "漏洞添加到数据库异常");
            this.task.getExceptions().add(e);
        }

    }

    private void after() {

    }


    public Task getTask() {
        return task;
    }

    public void setTask(Task task) {
        this.task = task;
    }

    public String getTarget() {
        return target;
    }

    public void setTarget(String target) {
        this.target = target;
    }
}
