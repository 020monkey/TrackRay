package com.trackray.scanner.exploit;

import com.trackray.scanner.bean.*;
import com.trackray.scanner.enums.HttpMethod;
import com.trackray.scanner.httpclient.CrawlerPage;
import com.trackray.scanner.httpclient.Fetcher;
import com.trackray.scanner.utils.PageUtils;
import org.apache.log4j.Logger;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public abstract class AbstractExploit implements Runnable{
    public Fetcher fetcher = new Fetcher();
    public CrawlerPage crawlerPage = new CrawlerPage();
    public Logger log = Logger.getLogger(getClass());
    private List<Vulnerable> vulns = new ArrayList<>();
    private Task task;
    private Map<String,Object> tempMap = new HashMap<>();

    public void init(Task task){
        //...
    }
    public void attackAfter(Task task){
        //...
        CrawlerPage page = new CrawlerPage();
        page.getRequest().setUrl(Constant.Vuln.VULN_ADD_API);
        page.getRequest().setHttpMethod(HttpMethod.POST);
        page.getRequest().addHttpHeader("Content-Type","application/x-www-form-urlencoded");
        page.getRequest().addHttpHeader("Connection: keep-alive");

        HashMap<String, String> param = new HashMap<>();
        for (Vulnerable vuln : vulns) {
            try {
                param.clear();
                param.put("md5",task.getTaskMD5());
                param.put("payload",vuln.getPayload());
                param.put("message",vuln.getMessage());
                param.put("vulnid",vuln.getVulnInfo().getVulnID());
                param.put("aboutLink",vuln.getVulnInfo().getAboutLink());
                param.put("vulnType",String.valueOf(vuln.getVulnInfo().getVulnType().getId()));
                param.put("response",vuln.getResponse().toString());
                param.put("level",String.valueOf(vuln.getVulnInfo().getVulnLevel().getLevel()));
                page.getRequest().setParamMap(param);
                fetcher.run(page);
            }catch (Exception e){}
        }
    };
    protected void add(Vulnerable vulnerable){
        if (vulnerable.getVulnInfo().getVulnLevel() == null
                ||vulnerable.getVulnInfo().getVulnType() ==null
                )
            return;
        getVulns().add(vulnerable);
    }
    public abstract List<Vulnerable> attack(Task task);
    public abstract boolean check(Result result);
    private final void todo(){}
    @Override
    public void run() {
        executor();
    }
    public void executor(){
        PageUtils.copyTaskProxy(task,crawlerPage);
        if (check(task.getResult())){

            init(task);
            log.info("exploit init...");

            List<Vulnerable> vuls = attack(task);
            if (!vuls.isEmpty())
            {
                log.info("exploit attack success...");
                attackAfter(task);
            }else{
                log.info("not vulnerable...");
            }
        }
    }
    protected  List<Vulnerable> vulns(){return getVulns();}
    private List<Vulnerable> getVulns() {
        return vulns;
    }

    public Map<String, Object> getTempMap() {
        return tempMap;
    }

    public Task getTask() {
        return task;
    }

    public void setTask(Task task) {
        this.task = task;
    }

}
